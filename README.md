# 🧠 SSH 批量任务执行工具

本项目是一个基于 Go 开发的 **SSH 批量自动化执行工具**，  
支持以下功能：

- ✅ 从多个 `.env` 配置文件加载不同服务器信息  
- ✅ 并发执行多台主机命令  
- ✅ 支持旧版 SSH 算法（适配老设备）  
- ✅ 输出日志自动保存  
- ✅ 可配置定时任务（CRON 表达式）  

---

## 📁 目录结构

```

project/
├── main.go              # 主程序源码
├── configs/             # 存放每台服务器的配置文件
│   ├── server1.env
│   ├── server2.env
│   └── ...
└── logs/                # 自动生成的执行输出日志

````

> **说明：**
> - `configs/` 下的每个 `.env` 表示一台服务器。
> - `logs/` 目录在程序运行后自动创建，用于存放每次执行结果。

---

## ⚙️ 配置文件说明 (`.env`)

每个 `.env` 文件对应一台服务器，以下是配置示例：

```ini
# ===============================
# SSH 基础信息
# ===============================
SSH_HOST=192.168.1.10
SSH_PORT=22
SSH_USER=USER
SSH_PASS=PASS

# 若为旧版 SSH 设备，请启用旧算法支持
SSH_LEGACY=true

# ===============================
# 执行命令（顺序执行）
# ===============================
CMD_1=show version
CMD_2=show interface
CMD_1_WAIT=2
CMD_2_WAIT=3

# 输出读取超时（秒）
OUTPUT_TIMEOUT=5

# ===============================
# 可选：定时任务（CRON 表达式）
# ===============================
# 每 30 秒执行一次
# CRON=*/30 * * * * *
```

### 📋 命令配置规则

* `CMD_1`, `CMD_2`, ... 依次为要执行的命令。
* `CMD_n_WAIT` 表示执行完命令后等待的秒数。
* 所有命令执行完成后，输出内容将自动保存至 `logs/`。

### 🕒 定时任务（可选）

若配置了 `CRON` 表达式，则该主机会周期性执行任务。
否则，只在启动时执行一次。

---

## 🚀 运行方式

### 1️⃣ 单次执行所有服务器

直接运行程序即可：

```bash
$ go run main.go
```

程序会：

* 自动读取 `configs/` 下的所有 `.env` 文件；
* 并发连接所有服务器；
* 执行命令；
* 保存输出至 `logs/xxxx_xxx.log`。

---

### 2️⃣ 定时任务模式

如果 `.env` 文件中配置了 `CRON` 表达式，程序会：

* 启动一个定时任务；
* 按配置的周期自动执行命令；
* 运行后常驻，按计划执行；
* 可用 `Ctrl + C` 手动停止。

示例日志输出：

```
✅ 初始化完成，共加载 2 个服务器配置
🕒 [192.168.1.10] 定时任务已注册 (*/30 * * * * *)
🕒 [192.168.1.20] 定时任务已注册 (0 0 * * * *)
✅ 定时任务已启动，按 Ctrl+C 退出
```

---

## 📂 输出日志

执行完成后，程序会将每台服务器的输出写入 `logs/` 目录中，文件名格式为：

```
logs/{主机IP}_{时间戳}.log
```

例如：

```
logs/192.168.1.10_20251015123000.log
```

---

## ⚡ 高级特性

| 功能          | 说明                                                     |
| ----------- | ------------------------------------------------------ |
| 🧵 并发执行     | 多台服务器同时运行任务                                            |
| 🔐 旧 SSH 支持 | `SSH_LEGACY=true` 启用 `diffie-hellman-group1-sha1` 等老算法 |
| 🕒 定时任务     | 通过 `CRON` 自动执行                                         |
| 🪶 自动日志     | 每次任务生成独立日志文件                                           |
| 🧩 隔离加载     | 每个 `.env` 独立，不会互相污染                                    |

---

## 🧩 常见问题

### Q1: 程序提示 `ssh: handshake failed: no common algorithm for key exchange`

👉 说明目标服务器只支持旧算法。
在 `.env` 中启用：

```ini
SSH_LEGACY=true
```

---

### Q2: 多台服务器执行时日志混乱？

程序会为每台服务器单独输出到 `logs/`，日志不会混杂在一起。
控制台日志只显示简要过程。

---

### Q3: 新增服务器

只需在 `configs/` 中添加一个新的 `.env` 文件即可，无需修改代码。

---

## 🏁 示例运行截图

```
✅ 初始化完成，共加载 2 个服务器配置 (耗时 15ms)
🚀 开始执行 2 台服务器任务...
🔗 [192.168.1.10] 连接中...
🔗 [192.168.1.20] 连接中...
✅ [192.168.1.10] 完成 (耗时 7s, 输出 1482 字节)
✅ [192.168.1.20] 完成 (耗时 8s, 输出 1023 字节)

📊 执行完成: 成功 2 / 失败 0 / 总计 2 / 用时 8s
```
